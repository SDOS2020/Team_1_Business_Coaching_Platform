<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		{% load static %}
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="{% static 'home/main.css' %}">
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<script src="{% static 'dashboard/components/connection_list.js' %}"></script>
		<script src="{% static 'dashboard/components/chat_box.js' %}"></script>
		<link rel="stylesheet" type="text/css" href="{% static 'dashboard/chat_style.css' %}">
		<title> Dashboard</title>
	</head>
	<body>
		<header class="site-header">
			<nav class="navbar navbar-expand-md navbar-light fixed-top" style="background-color: #baedf7; z-index: 100;">
				<div class="container">
					<a class="navbar-brand mr-4" href="{% url 'home' %}">Business Coaching</a>
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggle" aria-controls="navbarToggle" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
					</button>
					<div class="collapse navbar-collapse" id="navbarToggle">
						<div class="navbar-nav mr-auto">
							<a class="nav-item nav-link" href="{% url 'home' %}">Home</a>
							{% if user.is_authenticated %}
							<a class="nav-item nav-link" href="{% url 'dashboard' %}">Dashboard</a>
							{% endif %}
						</div>
						<!-- Navbar Right Side -->
						<div class="navbar-nav">
							{% if user.is_authenticated %}
							<a class="nav-item nav-link" href="{% url 'profile' user.pk %}">Profile</a>
							<a class="nav-item nav-link" href="{% url 'logout' %}">Logout</a>
							{% else %}
							<a class="nav-item nav-link" href="{% url 'login' %}">Login</a>
							<a class="nav-item nav-link" href="{% url 'register_coach' %}">Register as Coach</a>
							<a class="nav-item nav-link" href="{% url 'register_coachee' %}">Register as Client</a>
							{% endif %}
						</div>
					</div>
					
				</div>
			</nav>
		</header>
		<div class="container" style="float: left; padding-left: 10%; width: 200px;">
			<div class="row" style="overflow:auto; width: 250px;">
				<nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse" style="float: left;">
					<div class="sidebar-sticky pt-3">
						<ul class="nav flex-column">
							<li class="nav-item">
								<a class="nav-link active" href="#">
								<span data-feather="home"></span>
								Dashboard <span class="sr-only">(current)</span>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link active" href="#schedule-meeting">
								<span data-feather="home"></span>
								Upcoming Events <span class="sr-only">(current)</span>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link active" href="#app">
								<span data-feather="home"></span>
								Client Requests <span class="sr-only">(current)</span>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link active" href="#">
								<span data-feather="home"></span>
								Client Pages <span class="sr-only">(current)</span>
								</a>
							</li>
						</ul>
					</div>
					<div class="container" id="chat-container" style="margin-top: 25px;">
						<chat-box :user_pk="vue_selected_user_pk" :user_name="vue_selected_user_username" is_coach="{{user.is_coach}}"></chat-box>
						<connection-list v-on:request_chat="load_chat" is_coach="{{user.is_coach}}"></connection-list>
					</div>
				</nav>
			</div>
		</div>
		<!-- About Me -->
		<div id ="about-me">
			<div class="media">
				<img class="rounded-circle account-img" src="{{ profile.coach.profile_photo.url }}">        
				<div class="media-body">
					<h2 class="account-heading">{{ profile.coach.first_name }} {{ profile.coach.last_name }}</h2>
					<p class="text-secondary">{{ profile.email }}</p>
				</div>
			</div>
		</div>


		<!-- Google Calendar/ Upcoming Events -->
		<link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="{% static 'dashboard/style.css' %}">
		<link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
		<div class="main-container-wrapper" id = "my-calendar" style="float: right; width: 414px; position:fixed;right:5%;top:5%;">
			<div class='authentification' style="min-height: 40px;">
				<div class='row'>
					<div class='col'>
						<h4 style="width:fit-content"> My Calendar</h4>
					</div>
					<div class='col'>
						<button  type="button" class="btn btn-secondary" id="authorize_button" style="display: none; ">Authorize</button>
						<button  type="button" class="btn btn-secondary"  id="signout_button" style="display: none;">Sign Out</button>
					</div>
				</div>
			</div>
			<div class="events-container" style ="overflow:auto; height: 400px; right: 1%; bottom: 1%;;" v-if="authorized">
				<span class="events__title"> Upcoming events this week</span>
				<ul class="events__list" id = "add-calendar">
				</ul>
			</div>
		</div>
		
		<!-- Trying vue JS -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<script src="https://apis.google.com/js/api.js"></script>
		<script src="https://unpkg.com/vue/dist/vue.js"></script>
		<script src="https://unpkg.com/vue-cookies@1.5.12/vue-cookies.js"></script>
	  
		<script>
			// Client ID and API key from the Developer Console
			var CLIENT_ID = '819280097234-ss817nfmqbh9np1p7itjrii6t7v112kh.apps.googleusercontent.com';
		  	var API_KEY = 'AIzaSyCDzAX35SUf5lcqjCOKiNKkosSmKnULUfY';
			// Array of API discovery doc URLs for APIs used by the quickstart
			const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'];
			// Authorization scopes required by the API; multiple scopes can be
			// included, separated by spaces.
			const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';


			new Vue({
			el: '#my-calendar',
			delimiters: ['[[', ']]'],

			data() {
				return {
					items: undefined,
					api: undefined,
					authorized: false
				}
			},
			created() {
				console.log('Created')
				this.api = gapi;
				this.handleClientLoad();
			},

			methods: {
				/**
				 *  On load, called to load the auth2 library and API client library.
				 */
				handleClientLoad() {
					this.api.load('client:auth2', this.initClient);
				},

				/**
				 *  Initializes the API client library and sets up sign-in state
				 *  listeners.
				 */
				initClient() {
				let vm = this;

				vm.api.client.init({
					apiKey: API_KEY,
					clientId: CLIENT_ID,
					discoveryDocs: DISCOVERY_DOCS,
					scope: SCOPES
				}).then(_ => {
					// Listen for sign-in state changes.
					vm.api.auth2.getAuthInstance().isSignedIn.listen(vm.authorized);
				});
				},

				/**
				 *  Sign in the user upon button click.
				 */
				handleAuthClick(event) {
				Promise.resolve(this.api.auth2.getAuthInstance().signIn())
					.then(_ => {
					this.authorized = true;
					this.getData();
					});
				},

				/**
				 *  Sign out the user upon button click.
				 */
				handleSignoutClick(event) {
				Promise.resolve(this.api.auth2.getAuthInstance().signOut())
					.then(_ => {
					this.authorized = false;
					});
				},

				/**
				 * Print the summary and start datetime/date of the next ten events in
				 * the authorized user's calendar. If no events are found an
				 * appropriate message is printed.
				 */
				getData() {
					let vm = this;
					vm.api.client.calendar.events.list({
						'calendarId': 'primary',
						'timeMin': (new Date()).toISOString(),
						'showDeleted': false,
						'singleEvents': true,
						'maxResults': 10,
						'orderBy': 'startTime'
					}).then(response => {
						// console.log(response.result.items)
						vm.items = response.result.items;
						// console.log(vm.items);
					});
				}
			}
			});
		</script> -->

		<div id = "my-calendar" class="container">
	
	
			<script type="text/javascript">
			  // Client ID and API key from the Developer Console
			  var CLIENT_ID = '819280097234-ss817nfmqbh9np1p7itjrii6t7v112kh.apps.googleusercontent.com';
			  var API_KEY = 'AIzaSyCDzAX35SUf5lcqjCOKiNKkosSmKnULUfY';
		
			  // Array of API discovery doc URLs for APIs used by the quickstart
			  var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
		
			  // Authorization scopes required by the API; multiple scopes can be
			  // included, separated by spaces.
			  var SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
		
			  var authorizeButton = document.getElementById('authorize_button');
			  var signoutButton = document.getElementById('signout_button');
		
			  /**
			   *  On load, called to load the auth2 library and API client library.
			   */
			  function handleClientLoad() {
				gapi.load('client:auth2', initClient);
			  }
		
			  /**
			   *  Initializes the API client library and sets up sign-in state
			   *  listeners.
			   */
			  function initClient() {
				gapi.client.init({
				  apiKey: API_KEY,
				  clientId: CLIENT_ID,
				  discoveryDocs: DISCOVERY_DOCS,
				  scope: SCOPES
				}).then(function () {
				  // Listen for sign-in state changes.
				  gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
		
				  // Handle the initial sign-in state.
				  updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
				  authorizeButton.onclick = handleAuthClick;
				  signoutButton.onclick = handleSignoutClick;
				}, function(error) {
				  appendPre(JSON.stringify(error, null, 2));
				});
			  }
		
			  /**
			   *  Called when the signed in status changes, to update the UI
			   *  appropriately. After a sign-in, the API is called.
			   */
			  function updateSigninStatus(isSignedIn) {
				if (isSignedIn) {
				  authorizeButton.style.display = 'none';
				  signoutButton.style.display = 'block';
				  listUpcomingEvents();
				} else {
				  authorizeButton.style.display = 'block';
				  signoutButton.style.display = 'none';
				}
			  }
		
			  /**
			   *  Sign in the user upon button click.
			   */
			  function handleAuthClick(event) {
				gapi.auth2.getAuthInstance().signIn();
			  }
		
			  /**
			   *  Sign out the user upon button click.
			   */
			  function handleSignoutClick(event) {
				gapi.auth2.getAuthInstance().signOut();
			  }
		
			  /**
			   * Append a pre element to the body containing the given message
			   * as its text node. Used to display the results of the API call.
			   *
			   * @param {string} message Text to be placed in pre element.
			   */
			  function appendPre(message) {
				var pre = document.getElementById('add-calendar');
				pre.innerHTML += message;
				// var textContent = document.createTextNode(message + '\n');
				// pre.appendChild(textContent);
			  }
		
			  /**
			   * Print the summary and start datetime/date of the next ten events in
			   * the authorized user's calendar. If no events are found an
			   * appropriate message is printed.
			   */
			  function listUpcomingEvents() {
				gapi.client.calendar.events.list({
				  'calendarId': 'primary',
				  'timeMin': (new Date()).toISOString(),
				  'showDeleted': false,
				  'singleEvents': true,
				  'maxResults': 10,
				  'orderBy': 'startTime'
				}).then(function(response) {
				  var events = response.result.items;
				//   appendPre('Upcoming events:');
		
				  if (events.length > 0) {
					for (i = 0; i < events.length; i++) {
					  var event = events[i];
					  var when = event.start.dateTime;
					  if (!when) {
						when = event.start.date;
					  }
					  var message = '<li class="events__item">\
						<div class="events__item--left">\
							<span class="events__name">' + event.summary + '</span>\
							<span class="events__date">' + when + '</span>\
						</div>\
						</li>'
						appendPre(message)
					//   appendPre(event.summary + ' (' + when + ')')
					}
				  } else {
					// appendPre('No upcoming events found.');
				  }
				});
			  }
		
			</script>
		
			<script async defer src="https://apis.google.com/js/api.js"
			  onload="this.onload=function(){};handleClientLoad()"
			  onreadystatechange="if (this.readyState === 'complete') this.onload()">
			</script>
	
		</div>

	<!-- Chat Box -->
	
	
	<script>
        new Vue({
            delimiters: ['[[', ']]'],
			el: '#chat-container',
			components: {
				'connection-list' : connectionList,
				'chat-box': chatBox
			},
            data: {
				vue_selected_user_pk: '',
				vue_selected_user_username: '',
            },
            methods: {
                load_chat(user) {
					this.vue_selected_user_pk = user.user_pk; 
					this.vue_selected_user_username = user.first_name + ' ' + user.last_name; 
                },
                
            },
        });
        function get_cookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
	}
    </script>
	</body>
</html>